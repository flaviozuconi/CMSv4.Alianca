@model MLPaginaAdmin
@{
    var portal = PortalAtual.Obter;
    var urlLista = string.Format("/cms/{0}/pagina", portal.Diretorio);
    var urlSalvar = string.Format("/cms/{0}/pagina/item", portal.Diretorio);
    var urlSripts = string.Format("/cms/{0}/pagina/scripts", portal.Diretorio);
    var urlExcluir = string.Format("/cms/{0}/pagina/excluirpagina", portal.Diretorio);
    var urlSeo = string.Format("/cms/{0}/pagina/seooutros", portal.Diretorio);

    var publicada = (bool?)ViewData["Publicada"] ?? false;
    var permissao = (MLPaginaPermissaoCompleta)ViewData["Permissoes"] ?? new MLPaginaPermissaoCompleta();
    var gruposcliente = (List<MLGrupoCliente>)ViewData["GruposCliente"] ?? new List<MLGrupoCliente>();
    var assuntos = (List<MLAssuntos>)ViewData["Assuntos"] ?? new List<MLAssuntos>();
    var AssuntosPermissoes = (List<MLAssuntosXPaginas>)ViewData["AssuntosPermissoes"] ?? new List<MLAssuntosXPaginas>();
    var nomeLayoutEdicao = Model.PaginaEdicao != null ? Model.PaginaEdicao.NomeLayout : "";
    var nomeTemplateEdicao = Model.PaginaEdicao != null ? Model.PaginaEdicao.NomeTemplate : "";

    var templates = (List<MLTemplate>)ViewData["Templates"];
    var layouts = (List<MLLayout>)ViewData["Layouts"];

    var templatePagina = (MLTemplate)ViewData["TemplatePagina"];
    var modulos = (List<MLModulo>)ViewData["Modulos"];

    bool podeExcluir = AdminHelper.CheckPermission(Permissao.Excluir);
    bool podeModificar = AdminHelper.CheckPermission(Permissao.Modificar);
    bool paginaPublicada = podeModificar && Model.PaginaEdicao.Codigo.HasValue && Model.PaginaPublicada.Codigo.HasValue;
}
@Helpers.PainelConfirmacao("painelRecuperar", T("Recuperar Página Publicada"), T("Deseja recuperar a versão mais recente publicada desta página? As alterações realizadas na página serão perdidas e não podem ser restauradas."), string.Format("recuperarPaginaPublicada('{0}',{1});", portal.Diretorio, Model.Codigo))
<!-- Modal de Propriedades -->
<div class="modal modal-flex fade" id="construcaoModal" tabindex="-1" role="dialog" aria-labelledby="flexModalLabel" aria-hidden="true"></div>
<div class="modal modal-flex fade" id="excluirModal" tabindex="-1" role="dialog" aria-labelledby="excluirModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                <h4 class="modal-title">@TAdm("Excluir página")</h4>
            </div>
            <div class="modal-body clearfix">@TAdm("Deseja excluir esta página?")</div>
            <div class="modal-footer">
                <button type="button" class="btn btn-white" data-dismiss="modal">@TAdm("Fechar")</button>
                <button type="button" onclick="excluirPagina(); return false;" class="btn btn-white">@TAdm("Excluir")</button>
            </div>
        </div>
        <!-- /.modal-content -->
    </div>
</div>
<div class="modal modal-flex fade" id="seoModal" tabindex="-1" role="dialog" aria-labelledby="flexModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="post" id="formseo" action="@urlSeo">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                    <h4 class="modal-title">@TAdm("SEO Outros")</h4>
                </div>
                <div class="modal-body clearfix">
                    <div class="form-group col-md-12">
                        <div class="form-group col-md-12">
                            <p>@TAdm("Informações complementares para adição de SEO na página. Só exibe após publicado.")</p>
                            <input type="hidden" name="CodigoPagina" value="@Model.Codigo" />
                            <textarea data-editor="html" id="SeoOutros" name="SeoOutros" style="height: 300px; width: 500px;">@Model.Seo.Outros.Unescape()</textarea>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-white" data-dismiss="modal">@TAdm("Fechar")</button>
                    <button type="button" onclick="return salvarPagina($('#buttonSalvar'),'@portal.Diretorio',$('#formseo'))" class="btn btn-white">@TAdm("Salvar")</button>
                </div>
            </form>
        </div>
    </div>
</div>
<!-- /.modal -->
<form action="@urlSalvar" name="formPagina">
    <div class="portlet portlet-dark-blue">
        <div class="portlet-heading clearfix">
            <div class="portlet-title">
                <h4>
                    <img src="~/iconpack.axd/16/application_view_gallery" />
                    @TAdm("Página") [ <a href="/@(portal.Diretorio)/@Model.Url" target="_blank">@Model.Nome <i class="glyphicon glyphicon-new-window" style="font-size: 12px;" aria-hidden="true"></i></a> ]
                </h4>
            </div>
            <div class="portlet-widgets">
                <a href="javascript:;" onclick="return atualizarPagina();" title="@TAdm("Atualizar Página")"><i class="fa fa-refresh"></i></a>&nbsp;&nbsp;&nbsp;

                @if (!publicada)
                {
                    <a class="btn btn-green" onclick="return publicarPagina($(this),'/cms/@portal.Diretorio/pagina/publicar/@Model.Codigo')" href="javascript:;">@TAdm("Publicar")</a>
                    <a class="btn btn-red" href="javascript:;" id="buttonSalvar" onclick="return salvarPagina($(this),'@portal.Diretorio');">@TAdm("Salvar")</a>
                }
                else
                {
                    <a class="btn btn-green" href="/cms/@portal.Diretorio/pagina/editar/@Model.Codigo">@TAdm("Editar")</a>
                }

                <a class="btn btn-purple" href="/cms/@portal.Diretorio/conteudo/visualizar/@Model.Codigo" target="_blank">@TAdm("Visualizar")</a>
                <a class="btn btn-orange" href="/cms/@portal.Diretorio/pagina">@TAdm("Cancelar")</a>
                @if (!publicada)
                {
                    <div class="btn-group">
                        <button type="button" class="btn btn-blue dropdown-toggle" data-toggle="dropdown">
                            @TAdm("Mais Opções")
                            <span class="caret"></span>
                        </button>
                        <ul class="dropdown-menu" role="menu">
                            @if (podeExcluir)
                            {
                                <li><a data-toggle="modal" data-target="#excluirModal" href="javascript:;">@TAdm("Excluir")</a></li>
                                <li class="divider"></li>
                            }
                            @if (paginaPublicada)
                            {
                                <li><a onclick="$('#painelRecuperar').show();return false;" href="javascript:;">@TAdm("Recuperar Publicada")</a></li>
                                <li><a data-toggle="modal" data-target="#construcaoModal" onclick="showHistorico(@Model.Codigo,'@portal.Diretorio');return false;" href="javascript:;">@TAdm("Histórico")</a></li>
                                <li class="divider"></li>
                            }
                            <li><a href="#" onclick="@string.Format("window.location='/cms/{0}/pagina/item?duplicar={1}&publicado={3}'", portal.Diretorio, Model.Codigo, Model.CodigoSecao, Model.PaginaPublicada.Codigo.HasValue ? "true" : "false")">@TAdm("Duplicar")</a></li>
                        </ul>
                    </div>
                    @:&nbsp;&nbsp;
                    <a data-toggle="collapse" data-parent="#accordion" href="#formulario"><i class="fa fa-chevron-down"></i></a>
                }
            </div>
        </div>
        @if (!publicada)
        {
            <div id="formulario" class="panel-collapse collapse out">
                <div class="portlet-body clearfix">
                    <ul class="nav nav-tabs">
                        <li class="active"><a href="#principal" data-toggle="tab"><span class="glyphicon glyphicon-file"></span> @TAdm("Cadastro")</a></li>
                        <li><a href="#permissao" data-toggle="tab"><span class="glyphicon glyphicon-user"></span> @TAdm("Permissões")</a></li>
                        <li><a href="#seo" data-toggle="tab"><span class="glyphicon glyphicon-list-alt"></span> @TAdm("SEO - Redes Sociais")</a></li>
                        <li class="@(!paginaPublicada ? "disabled" : "")"><a href="#pageSpeed" data-toggle="@(paginaPublicada ? "tab" : "")"><span class="glyphicon glyphicon-stats"></span> @TAdm("Performance")</a></li>
                        <li><a href="#modulos" data-toggle="tab"><span class="glyphicon glyphicon-tasks"></span> @TAdm("Módulos")</a></li>
                        <li class="@(!paginaPublicada ? "disabled" : "")"><a href="#css" data-toggle="@(paginaPublicada ? "tab" : "")"><span class="glyphicon glyphicon-pencil"></span> @TAdm("CSS")</a></li>
                        <li class="@(!paginaPublicada ? "disabled" : "")"><a href="#scripts" data-toggle="@(paginaPublicada ? "tab" : "")"><span class="glyphicon glyphicon-pencil"></span> @TAdm("Scripts")</a></li>
                    </ul>
                    <div class="tab-content">
                        <div id="principal" class="col-md-12 tab-pane active">
                            <input type="hidden" name="Codigo" value="@Model.Codigo" />
                            <input type="hidden" name="CodigoPai" value="@Model.CodigoPai" />
                            <div class="form-group col-md-6">
                                Layout: <br />
                                <select id="layout" class="form-control" name="NomeLayout">
                                    @foreach (var item in layouts)
                                    {
                                        <option value="@item.Nome" @(nomeLayoutEdicao == item.Nome ? "selected" : "")>@item.Nome</option>
                                    }
                                </select>
                            </div>

                            <div class="form-group col-md-6">
                                Template:

                                <select id="template" class="form-control" name="NomeTemplate">
                                    @foreach (var item in templates)
                                    {
                                        <option value="@item.Nome" @(nomeTemplateEdicao == item.Nome ? "selected" : "")>@item.Nome</option>
                                    }
                                </select>

                            </div>

                            <div class="form-group col-md-6">
                                <label for="Nome">@TAdm("Nome")</label>
                                <input type="text" class="form-control" name="Nome" id="Nome" maxlength="100" placeholder="@TAdm("Nome")" value="@Model.Nome">
                            </div>
                            <div class="form-group col-md-6">
                                <label for="Url">@TAdm("Url")</label>
                                <input type="Url" class="form-control" name="Url" id="Url" maxlength="100" placeholder="@TAdm("Url")" value="@Model.Url">
                            </div>
                            <div class="form-group col-md-6">
                                <label for="titulo">@TAdm("Título")</label>
                                <input type="text" class="form-control" name="PaginaEdicao.Titulo" id="Titulo" placeholder="@TAdm("Título")" value="@Model.PaginaEdicao.Titulo">
                            </div>
                            <div class="form-group col-md-6">
                                <label for="titulo">@TAdm("Idioma")</label>
                                @Helpers.ComboIdiomas(Model.CodigoIdioma, exibirSelecione: false)
                            </div>
                            <div class="form-group col-md-6">
                                <label>@TAdm("Descrição")</label>
                                <textarea class="form-control" rows="4" name="PaginaEdicao.Descricao" placeholder="@TAdm("Descrição")">@Model.PaginaEdicao.Descricao</textarea>
                            </div>

                            <div class="form-group col-md-6 tokenfield" data-value="blue">
                                <label>@TAdm("Tags")</label>
                                <input type="text" class="form-control" name="PaginaEdicao.Tags" id="tags" value="@Model.PaginaEdicao.Tags">
                                <span class="help-block"><small>@TAdm("Pressione TAB para separar as Tags")</small></span>
                            </div>

                            @if (assuntos.Count > 0)
                            {
                                <div class="form-group col-md-4">
                                    <label>@TAdm("Assuntos")</label><br />
                                    @foreach (var item in assuntos)
                                    {
                                        <input type="checkbox" class="highlight grupos" name="listaAssuntos" value="@item.Codigo" @(AssuntosPermissoes.Find(o => o.CodigoAssunto == item.Codigo) != null ? "checked" : "") />
                                        <label>@item.Assunto</label>
                                    }
                                </div>

                            }

                            <div class="form-group col-md-12">
                                @Html.CheckBox("Ativo", Model.Ativo) <label for="Ativo">@TAdm("Ativo")</label>&nbsp;&nbsp;&nbsp;
                                @Html.CheckBox("PaginaEdicao.ApresentarNaBusca", Model.PaginaEdicao.ApresentarNaBusca) <label for="PaginaEdicao_ApresentarNaBusca">@TAdm("Apresentar na Busca")</label>&nbsp;&nbsp;&nbsp;
                                @Html.CheckBox("Https", Model.Https) <label for="Https">@TAdm("HTTPS Obrigatório")</label>&nbsp;&nbsp;&nbsp;
                            </div>
                        </div>
                        <div id="permissao" class="col-md-12 tab-pane">
                            <input type="hidden" name="GruposPublico" id="jqGruposPublico" value="" />
                            <div class="form-group col-md-12">
                                @if (!permissao.PortalRestrito.HasValue || permissao.PortalRestrito.Value)
                                {
                                    <label>@TAdm("Portal com Acesso Liberado")</label>
                                }
                                else
                                {
                                    <label>@TAdm("Portal com Acesso Restrito")</label>
                                }
                            </div>
                            <div class="form-group col-md-12">
                                @if (!permissao.SecaoRestrita.HasValue)
                                {
                                    <label>@TAdm("Seção Utilizando permissões do portal")</label>
                                }
                                else if (permissao.SecaoRestrita.Value)
                                {
                                    <label>@TAdm("Seção com Acesso Restrito")</label>
                                }
                                else
                                {
                                    <label>@TAdm("Seção com Acesso Liberado")</label>
                                }
                            </div>
                            <div class="form-group col-md-4">
                                <select name="Restrito" class="form-control">
                                    <option value="" @(!Model.Restrito.HasValue ? "selected" : "")>@TAdm("Usar Permissões da Seção")</option>
                                    <option value="false" @(Model.Restrito.HasValue && !Model.Restrito.Value ? "selected" : "")>@TAdm("Liberado")</option>
                                    <option value="true" @(Model.Restrito.HasValue && Model.Restrito.Value ? "selected" : "")>@TAdm("Restrito")</option>
                                </select>
                            </div>
                            <div class="jqPermissao" style="display:@(Model.Restrito.HasValue && Model.Restrito.Value ? "block" : "none")">
                                @if (gruposcliente.Count > 0)
                                {
                                    <div class="clearfix"></div>
                                    for (int i = 0; i < gruposcliente.Count; i++)
                                    {
                                        <div class="form-group col-md-4">
                                            <input class="highlight grupos" type="checkbox" id="group_@i" name="listaCodigoGrupoCliente" value="@gruposcliente[i].Codigo" @(permissao.GruposPagina.Find(o => o.CodigoGrupo == gruposcliente[i].Codigo) != null ? "checked" : "") />
                                            <label for="group_@i">@gruposcliente[i].Nome</label>
                                        </div>
                                    }
                                    <div class="clearfix"></div>
                                    <div class="form-group col-md-6">
                                        <label for="UrlLogin">@TAdm("Url da página de Login")</label>
                                        <input type="text" class="form-control" name="PaginaEdicao.UrlLogin" id="UrlLogin" value="@Model.PaginaEdicao.UrlLogin">
                                    </div>
                                }
                                else
                                {
                                    <div class="alert alert-warning">
                                        @TAdm("Não há grupos Cadastrados para esse portal!")
                                    </div>
                                }
                            </div>
                        </div>
                        <div id="seo" class="col-md-12 tab-pane">
                            <div class="col-md-2">
                                <ul class="nav nav-pills nav-stacked">
                                    <li class="active">
                                        <a href="#seo_principal" data-toggle="tab">@TAdm("Gerais")</a>
                                    </li>
                                    <li>
                                        <a href="#seo_twitter" data-toggle="tab">Twitter Card</a>
                                    </li>
                                    <li>
                                        <a href="#seo_facebook" data-toggle="tab">Facebook Open Graph</a>
                                    </li>
                                    <li>
                                        <a href="#seo_icons" data-toggle="tab">Icons</a>
                                    </li>
                                    <li>
                                        <a data-toggle="modal" data-target="#seoModal" href="#">Outros</a>
                                    </li>
                                </ul>
                            </div>
                            <div class="col-md-10">
                                <div class="tab-content">
                                    <div class="tab-pane fade in active" id="seo_principal">
                                        <div class="form-group col-md-6">
                                            <label for="Schema">schema</label>
                                            <input type="text" class="form-control" name="Seo.Schema" id="Schema" placeholder="schema" value="@Model.Seo.Schema">
                                        </div>
                                        <div class="form-group col-md-6">
                                            <label for="Image">image</label>
                                            <input type="text" class="form-control" name="Seo.Image" id="Image" placeholder="image" value="@Model.Seo.Image">
                                        </div>

                                        <div class="form-group col-md-4">
                                            <label for="Copyright">copyright</label>
                                            <input type="text" class="form-control" name="Seo.Copyright" id="Copyright" placeholder="copyright" value="@Model.Seo.Copyright">
                                        </div>

                                        <div class="form-group col-md-4">
                                            <label for="RevisitAfter">revisit-after</label>
                                            <input type="text" class="form-control" name="Seo.RevisitAfter" id="RevisitAfter" placeholder="revisit-after" value="@Model.Seo.Revisitafter">
                                        </div>

                                        <div class="form-group col-md-4">
                                            <label for="Author">author</label>
                                            <input type="text" class="form-control" name="Seo.Author" id="Author" placeholder="author" value="@Model.Seo.Author">
                                        </div>
                                    </div>
                                    <div class="tab-pane fade" id="seo_twitter">
                                        <div class="form-group col-md-4">
                                            <label for="Card">twitter:card</label>
                                            <input type="text" class="form-control" name="Seo.TwitterCard" id="TwitterCard" placeholder="twitter:card" value="@Model.Seo.Twittercard">
                                        </div>
                                        <div class="form-group col-md-4">
                                            <label for="Site">twitter:site</label>
                                            <input type="text" class="form-control" name="Seo.TwitterSite" id="TwitterSite" placeholder="twitter:site" value="@Model.Seo.Twittersite">
                                        </div>
                                        <div class="form-group col-md-4">
                                            <label for="TwitterTitle">twitter:title</label>
                                            <input type="text" class="form-control" name="Seo.TwitterTitle" id="TwitterTitle" placeholder="twitter:title" value="@Model.Seo.Twittertitle">
                                        </div>
                                        <div class="form-group col-md-4">
                                            <label for="TwitterDescription">twitter:description</label>
                                            <input type="text" class="form-control" name="Seo.TwitterDescription" id="TwitterDescription" placeholder="twitter:description" value="@Model.Seo.Twitterdescription">
                                        </div>
                                        <div class="form-group col-md-4">
                                            <label for="TwitterImage">twitter:image</label>
                                            <input type="text" class="form-control" name="Seo.TwitterImage" id="TwitterImage" placeholder="twitter:image" value="@Model.Seo.Twitterimage">
                                        </div>
                                    </div>
                                    <div class="tab-pane fade" id="seo_facebook">
                                        <div class="form-group col-md-4">
                                            <label for="OgTitle">og:title</label>
                                            <input type="text" class="form-control" name="Seo.Ogtotitle" id="OgTitle" placeholder="og:title" value="@Model.Seo.Ogtotitle">
                                        </div>
                                        <div class="form-group col-md-4">
                                            <label for="OgSite_name">og:site_name</label>
                                            <input type="text" class="form-control" name="Seo.OgSiteName" id="OgSite_name" placeholder="og:site_name" value="@Model.Seo.Ogsitename">
                                        </div>
                                        <div class="form-group col-md-4">
                                            <label for="OgDescription">og:description</label>
                                            <input type="text" class="form-control" name="Seo.OgDescription" id="OgDescription" placeholder="og:description" value="@Model.Seo.Ogdescription">
                                        </div>
                                        <div class="form-group col-md-4">
                                            <label for="OgImage">og:image</label>
                                            <input type="text" class="form-control" name="Seo.OgImage" id="OgImage" placeholder="og:image" value="@Model.Seo.Ogimage">
                                        </div>
                                        <div class="form-group col-md-4">
                                            <label for="OgType">og:type</label>
                                            <input type="text" class="form-control" name="Seo.OgType" id="OgType" placeholder="og:type" value="@Model.Seo.Ogtype">
                                        </div>

                                        <div class="form-group col-md-4">
                                            <label for="OgLocale">og:locale</label>
                                            <input type="text" class="form-control" name="Seo.OgLocale" id="OgLocale" placeholder="og:locale" value="@Model.Seo.Oglocale">
                                        </div>

                                        <div class="form-group col-md-4">
                                            <label for="OgAuthor">og:author</label>
                                            <input type="text" class="form-control" name="Seo.OgAuthor" id="OgAuthor" placeholder="og:author" value="@Model.Seo.OgAuthor">
                                        </div>
                                        <div class="form-group col-md-4">
                                            <label for="OgPublisher">og:publisher</label>
                                            <input type="text" class="form-control" name="Seo.OgPublisher" id="OgPublisher" placeholder="og:publisher" value="@Model.Seo.Ogpublisher">
                                        </div>
                                    </div>
                                    <div class="tab-pane fade" id="seo_icons">
                                        <div class="form-group col-md-4">
                                            <label for="ShortcutIcon">shortcut icon</label>
                                            <input type="text" class="form-control" name="Seo.ShortcutIcon" id="ShortcutIcon" placeholder="shortcut icon" value="@Model.Seo.Shortcuticon">
                                        </div>
                                        <div class="form-group col-md-4">
                                            <label for="AppleTouchIcon">apple-touch-icon</label>
                                            <input type="text" class="form-control" name="Seo.AppleTouchIcon" id="AppleTouchIcon" placeholder="apple-touch-icon" value="@Model.Seo.Appletouchicon">
                                        </div>
                                    </div>
                                    <input type="hidden" name="Seo.Outros" id="Seo_Outros" value="@Model.Seo.Outros">
                                </div>
                            </div>
                        </div>

                        <div id="pageSpeed" class="col-md-12 tab-pane">
                            @{ Html.RenderPartial("~/Areas/CMS/Views/PageSpeed/Index.cshtml", Model.PaginaPublicada.PageSpeed); }
                        </div>

                        <div id="modulos" class="col-md-12 tab-pane">
                            <p>@T("Aqui você pode editar ou remover módulos da página.")</p>

                            <div class="row">

                                <div class="col-md-4">
                                    <label>Repositórios</label>
                                    <select class="form-control" id="selectRepositorios">
                                        <option value="">Selecione...</option>

                                        @for (int i = 1; i <= templatePagina.Repositorios; i++)
                                        {
                                            <option value="@i">@i</option>
                                        }
                                    </select>
                                </div>

                                <div class="col-md-4">
                                    <label>Módulos</label>

                                    <select class="form-control" id="selectModulos">
                                        <option value="">Selecione...</option>

                                        @foreach (var item in modulos)
                                        {
                                            <option value="@item.Codigo" data-editavel="@item.Editavel">@item.Nome</option>
                                        }
                                    </select>
                                </div>

                                <div class="col-md-4">
                                    <label>Ações</label>
                                    <br />
                                    <button type="button" id="btnAdicionarMod" data-button class="btn btn-default disabled"><i class="fa fa-plus"></i> @TAdm("Adicionar")</button>
                                    <button type="button" id="btnEditarMod" data-button class="btn btn-default disabled"><i class="fa fa-edit"></i> @TAdm("Editar")</button>
                                    <button type="button" id="btnRemoverMod" data-button class="btn btn-default disabled"><i class="fa fa-trash-o"></i> @TAdm("Excluir")</button>
                                </div>

                                @*@foreach (var modulo in Model.PaginaEdicao.Modulos)
                                    {
                                        <div class="col-md-4">
                                            <div class="btn-group btn-block">
                                                <button type="button" class="btn btn-block btn-default dropdown-toggle" data-toggle="dropdown">
                                                    @modulo.UrlModulo
                                                    <span class="caret"></span>
                                                </button>
                                                <ul class="dropdown-menu" role="menu">

                                                    @if (modulo.Editavel.GetValueOrDefault(false))
                                                    {
                                                        <li>
                                                            <a href="#" onclick="click_editarModulo(@modulo.Repositorio);">@T("Editar")</a>
                                                        </li>

                                                        <li class="divider"></li>
                                                    }

                                                    <li>
                                                        <a href="#">@T("Deletar")</a>
                                                    </li>
                                                </ul>
                                            </div>
                                            <small>Repositório: @modulo.Repositorio</small>
                                        </div>
                                    }*@
                            </div>

                        </div>



                        @if (paginaPublicada)
                        {
                        <div id="css" class="col-md-12 tab-pane">
                            <p>@Html.Raw("<code>&lt;style type=\"text/css\"&gt;</code>")</p>
                            <textarea data-editor="css" name="PaginaEdicao.Css" style="height: 200px; width: 100% !important;">@Model.PaginaEdicao.Css.Unescape()</textarea>
                            <p>@Html.Raw("<code>&lt;/style&gt;</code>")</p>
                        </div>
                        <div id="scripts" class="col-md-12 tab-pane">
                            <p>@Html.Raw("<code>&lt;script type=\"text/javascript\"&gt;</code>")</p>
                            <textarea data-editor="javascript" name="PaginaEdicao.Scripts" style="height: 200px; width: 100% !important;">@Model.PaginaEdicao.Scripts.Unescape()</textarea>
                            <p>@Html.Raw("<code>&lt;/script&gt;</code>")</p>
                        </div>
                        }
                    </div>
                </div>
            </div>
        }
    </div>
</form>
<p id="CarregandoPagina"><i class="fa fa-spinner fa-spin"></i> @TAdm("Construindo a página, por favor aguarde...")</p>
<iframe id="iframePagina" src="/cms/@portal.Diretorio/pagina/itempagina/@Model.Codigo?edit=1" style="width:100%;height:800px;border:1px solid #000;display: none;" onload="changeVisibility(); setIframeHeight(this);"></iframe>

@section head {
    <link href="~/Content/css/plugins/bootstrap-tokenfield/bootstrap-tokenfield.css" rel="stylesheet" />

    <style type="text/css">
        .nav-tabs li a {
            outline: 0;
        }

        .portlet-dark-blue {
            margin-bottom: 15px;
        }
    </style>

    
}
@section scripts {
    <script src="~/Content/js/plugins/html2canvas/html2canvas.js" type="text/javascript"></script>
    <script src="~/content/areaconstrucao/areaconstrucao.js?@(Guid.NewGuid().ToString())" type="text/javascript"></script>
    <script src="~/Content/js/plugins/bootstrap-tokenfield/bootstrap-tokenfield.min.js"></script>
    <script src="~/Content/js/plugins/AceEditor/ace.js"></script>
    <script src="~/Content/js/plugins/jquery-knob/jquery.knob.min.js"></script>
    <script src="~/Content/js/modulos/PageSpeed/index.js"></script>

    <script type="text/javascript">
        var portalDiretorio = "@PortalAtual.Obter.Diretorio";

        function click_editarModulo(repositorio) {
            $("#iframePagina").contents().find(".linkEditar_" + repositorio).click();
        }

        function controleExibicaoBotoesModulos(){
            var moduloSelecionado = $("#selectModulos").val();
            var moduloSelecionadoEditavel = $("#selectModulos").find(':selected').data('editavel') == "True";
            var repositorioSelecionado = $("#selectRepositorios").val();

            $("[data-button]").addClass("disabled");

            if(repositorioSelecionado == "") {
                return;
            }

            if(moduloSelecionado > 0 ) {
                $("#btnRemoverMod").removeClass("disabled");

                if(moduloSelecionadoEditavel) {
                    $("#btnEditarMod").removeClass("disabled");
                }
            }
            else{
                $("#btnAdicionarMod").removeClass("disabled");
            }
        }

        $('#tags').tokenfield();

        $("form[name=formPagina]").validate({
            rules: {
                Nome: { required: true },
                Url: {
                    required: true, regex: /^[a-zA-Z_\-0-9]+$/, remote: {
                        url: "/cms/@(portal.Diretorio)/pagina/ValidarUrl",
                        type: "POST",
                        async: false,
                        loadingPanel: false,
                        data: { url: $("#Url").val(), id: "@Model.Codigo" }
                    }
                }
            },
            messages: {
                Url: {
                    remote: "@TAdm("Já existe uma página cadastrada com essa Url")"
                }
            }
        });

        $('select[name=Restrito]').on('change', function (event) {
            if ($(this).val() == 'true')
                $('.jqPermissao').show();
            else
                $('.jqPermissao').hide();
        });

        function excluirPagina() {
            var div = "<div class='msg-exclusao alert alert-danger row'><strong>@TAdm("Erro"):</strong> [[MSG]]</div>";

            $(".msg-exclusao").remove();

            $.post("@urlExcluir", { id: '@(Model.Codigo)' }, function (data) {
                if (data.success) {
                    window.location.href = "/cms/@portal.Diretorio/pagina";
                }
                else {
                    if (data.msg) {
                        $(div.replace("[[MSG]]", data.msg)).insertAfter("#formulario");
                    }
                }
            });
        }

        function atualizarPagina() {
            $("#iframePagina").attr("src", $("#iframePagina").attr("src"));
            setIframeHeight($("#iframePagina")[0]);

            return false;
        }

        function changeVisibility() {
            $("#CarregandoPagina").hide();
            $("#iframePagina").show();
        }

        function getDocHeight(doc) {
            doc = doc || document;

            var body = doc.body,
                html = doc.documentElement;

            return Math.max(body.scrollHeight, body.offsetHeight,  html.clientHeight, html.scrollHeight, html.offsetHeight);
        }

        function setIframeHeight(ifrm) {
            var doc = ifrm.contentDocument? ifrm.contentDocument : ifrm.contentWindow.document;
            var height = getDocHeight(doc) + 4;

            if (height < 400)
                height = 500;

            ifrm.style.visibility = 'hidden';
            ifrm.style.height = "10px";
            ifrm.style.height = height + "px";
            ifrm.style.visibility = 'visible';
        }

        $(document).ready(function() {

            var nav = $(".navbar-side", window.parent.document);

            if (!nav.hasClass("collapsed-construcao")){
                nav.addClass("collapsed");
                nav.addClass("collapsed-construcao");
                $("#page-wrapper", window.parent.document).addClass("collapsed");
            }

            $(".ace_editor").width("");

            scrollToTop();

            $("#selectRepositorios").change(function() {
                var select = $(this);
                var repositorioSelecionado = select.val();

                $("#selectModulos").removeAttr("disabled");

                $.post("/cms/@portal.Diretorio/Pagina/ObterModuloRepositorio", { CodigoPagina: @Model.Codigo, Repositorio: repositorioSelecionado
                }, function(model){
                    $("#selectModulos").val(model.CodigoModulo);

                    if(model.CodigoModulo > 0) {
                        $("#selectModulos").attr("disabled", "disabled");
                    }

                    controleExibicaoBotoesModulos();
                });
            });

            $("#btnAdicionarMod").click(function(){
                var repositorioSelecionado = $("#selectRepositorios").val();
                var moduloSelecionado = $("#selectModulos").val();

                if(moduloSelecionado == ""){
                    return;
                }

                //Encontrar o select que corresponde ao repositório onde será adicionado o novo módulo
                $("#iframePagina").contents().find("#cms-ac-rep-" + repositorioSelecionado).find('select[name="modulo"]').val(moduloSelecionado).trigger("change");

                $("#selectModulos").attr("disabled", "disabled");
                controleExibicaoBotoesModulos();

                window.parent.$.fn.ModalPadrao({
                    titulo: "@TAdm("Módulos")",
                    mensagem: "@TAdm("Módulo adicionado com sucesso.")",
                    exibirNaInicializacao: true,
                    tipo: "success"
                });
            });

            $("#btnEditarMod").click(function(){
                $("#iframePagina").contents().find(".linkEditar_" + $("#selectRepositorios").val()).click();
            });

            $("#btnRemoverMod").click(function(){
                $("#iframePagina").contents().find(".linkRemover_" + $("#selectRepositorios").val()).click();
                $("#selectModulos").val("");
                $("#selectModulos").removeAttr("disabled");

                controleExibicaoBotoesModulos();

                window.parent.$.fn.ModalPadrao({
                    titulo: "@TAdm("Módulos")",
                    mensagem: "@TAdm("Módulo removido com sucesso.")",
                    exibirNaInicializacao: true,
                    tipo: "success"
                });
            });
        });

        $(window).resize(function() {
            var ifrm = document.getElementById("iframePagina");
            setIframeHeight(ifrm);
        });

        $("#template, #layout").change(function () {
            $("#CarregandoPagina").show();
            $("#iframePagina").hide();

            document.getElementById("iframePagina").src = "/cms/@portal.Diretorio/pagina/itempagina/@Model.Codigo?edit=1&TempTemplate=" + $("#template").val() + "&TempLayout=" + $("#layout").val();
        });

        @if (publicada)
        {
            @:Mensagem('@TAdm("A página foi publicada com sucesso!")', 'success');
        }

    </script>

    @Helpers.BuscarPaginas("UrlLogin", portal.Diretorio, portal.Codigo, adicionarPortalNaUrl: true)
}